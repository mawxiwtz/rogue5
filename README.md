English | [Japanese](README_ja.md)

# Rogue 5.4.5x Japanese and WASM Patch

## What is this?

[Play demo](https://mawxiwtz.github.io/rogue5/)

This project provides and distributes patches for [Rogue 5.4.5x](http://yozvox.web.fc2.com/526F677565.html#rogue54) to achieve the following:

- Support for Japanese (UTF-8) messages and text input
- WebAssembly (WASM) support to play in a browser

Rogue 5.4.5x is an adjusted version of [Rogue 5.4.4](http://rogue.rogueforge.net/rogue-5-4/) by Y.Oz Vox.  
Japanese message translations were referenced from [jRogue for macOS (Japanese version Rogue 5.4)](https://github.com/leopard-gecko/homebrew-game).  
Messages switch between Japanese and English depending on the `LANG` environment variable.  
The only supported Japanese encoding is UTF-8. However, the support is minimal: surrogate pairs, NFD (Normalization Form Canonical Decomposition), and zero-width characters are not supported.  
This is an unofficial patch created as a personal hobby, so it may contain bugs not found in the original version.

Additionally, a patch is provided to build a WASM file using Emscripten to run Rogue in a web browser.  
By combining the built WASM file with xterm.js or xterm-pty, you can play Rogue in your browser.

## Usage

If you have Node.js installed, you can play locally as follows:

```bash
git clone https://github.com/mawxiwtz/rogue5
cd rogue5
npm install
npm run start
```

Access [http://localhost:3000/](http://localhost:3000/) in your browser.

## Building the Japanese-Compatible Rogue

This patch translates in-game messages into Japanese.  
Set the `LANG` environment variable to something like `ja_JP.UTF-8` to display Japanese.  
Use `en_US` or `C` to display English.  
Build and runtime tests have only been conducted on Linux. Windows and macOS are untested. Updates will be provided once verified.

1. Download and extract the [Rogue 5.4.5x source](http://yozvox.web.fc2.com/rogue5.4.5x-src.zip):

```bash
curl -OL http://yozvox.web.fc2.com/rogue5.4.5x-src.zip
unzip rogue5.4.5x-src.zip
cd rogue5.4.5x-src
```

2. Apply the Japanese support patch and build. Modify `configure` options as needed for your environment.

```bash
patch -p1 < ../rogue5.4.5x_ja.patch
chmod +x configure
./configure --prefix=/usr --enable-wizardmode
make
```

3. Run the game:

```bash
Recommended:
./rogue5 -24

To play in Japanese:
LANG=ja_JP.UTF-8 ./rogue5 -24
```

For gameplay instructions and options, refer to:

- [Guide to the Dungeons of Doom](http://yozvox.web.fc2.com/rogue54_jp.html)
- [History](http://yozvox.web.fc2.com/HistoryOfRogue.txt)

The meaning of the `-24` option can be found at the end of `README.txt` included in the Rogue 5.4.5x source code.

## Building the Japanese + WASM (Emscripten) Version of Rogue

This section describes how to create a Japanese-compatible version of Rogue that runs in a web browser.

### Prerequisites

First, prepare [Emscripten](https://emscripten.org/) and [Emscripten-compatible Ncurses-6.5](build_ncurses.md). Confirm that `emcc` is executable:

```bash
$ emcc --version
emcc (Emscripten gcc/clang-like replacement + linker emulating GNU ld) 4.0.11 (d3432e7a2a6585331c94b041973fb16c9f332ce4)
Copyright (C) 2025 the Emscripten authors (see AUTHORS.txt)
This is free and open source software under the MIT license.
There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
```

Then, download the following necessary files:

- [emscripten-pty.js](https://github.com/mame/xterm-pty/raw/refs/heads/main/emscripten-pty.js)  
  A script from [xterm-pty](https://github.com/mame/xterm-pty), required to display the WASM Rogue screen using xterm.js and handle key input.
- xterm-256color  
  This is generated by building [ncurses-6.5.tar.gz](https://invisible-island.net/archives/ncurses/ncurses-6.5.tar.gz). Alternatively, you may use the one under your OS's `/usr/share/terminfo/x/`.
- pre.js  
  Create this file yourself with the following contents:

```javascript
Module['preRun'] = [
    () => {
        const url = new URL(import.meta.url);
        const dir = url.pathname.substring(0, url.pathname.lastIndexOf('/'));

        FS.mkdir('/home/web_user/.terminfo', 555);
        FS.mkdir('/home/web_user/.terminfo/x', 555);
        FS.createPreloadedFile(
            '/home/web_user/.terminfo/x',
            'xterm-256color',
            `${dir}/xterm-256color`,
            true,
            false,
        );
        FS.createPreloadedFile('/', 'rogue.ttl', `${dir}/rogue.ttl`, true, false);
    },
];
```

### Build

Download and extract the Rogue 5.4.5x source:

```bash
curl -OL http://yozvox.web.fc2.com/rogue5.4.5x-src.zip
unzip rogue5.4.5x-src.zip
cd rogue5.4.5x-src
```

Apply the patches for Japanese and WASM support:

```bash
patch -p1 < ../rogue5.4.5x_ja.patch
patch -p1 < ../rogue5.4.5x_emscripten.patch
```

Set the `NCURSESDIR` environment variable to the path of the [Ncurses library](build_ncurses.md) used for Emscripten linking:

```bash
export NCURSESDIR=xxxxxxx
```

Run `emconfigure`:

```bash
chmod +x configure
emconfigure ./configure \
  --prefix=/usr \
  --enable-wizardmode \
  CFLAGS="-I${NCURSESDIR}/usr/include" \
  LDFLAGS="-L${NCURSESDIR}/usr/lib" \
  --with-js-library=../emscripten-pty.js \
  --with-pre-js=../pre.js
```

Build the project:

```bash
emmake make
```

If `rogue5.mjs` and `rogue5.wasm` are created, the build was successful.  
Create an `index.html` file like the following and place it with `rogue5.mjs`, `rogue5.wasm`, `rogue.ttl` (included in the Rogue 5.4.5x source), and `xterm-256color` in a `lib` directory.  
Start a web server and access `index.html`. Note: opening it locally in a browser will not work.

```html
<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="icon" href="./lib/rogue.png" type="image/png" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css"
        />
    </head>

    <body>
        <div id="container">
            <h1>Rogue 5.4.5x WASM</h1>
            <div id="terminal"></div>
            <div class="info">
                <img
                    src="https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/github.svg"
                    alt="GitHub Logo"
                    width="32"
                    height="32"
                />
                <a href="https://github.com/mawxiwtz/rogue5">https://github.com/mawxiwtz/rogue5</a>
            </div>
        </div>
        <script type="module">
            import { Terminal } from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';
            import { FitAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
            import { openpty } from 'https://cdn.jsdelivr.net/npm/xterm-pty@0.11.1/+esm';
            import initEmscripten from './lib/rogue5.mjs';

            const xterm = new Terminal({
                cols: 80,
                rows: 24,
                fontSize: 14,
            });
            xterm.open(document.getElementById('terminal'));

            const fitAddon = new FitAddon();
            xterm.loadAddon(fitAddon);

            const { master, slave } = openpty();

            xterm.loadAddon(master);
            xterm.focus();

            await initEmscripten({
                pty: slave,
                arguments: ['-24'],
            });
        </script>
        <style>
            body {
                color: white;
                margin: 0px 0px;
                background-color: #202020;
            }
            a {
                text-decoration: none;
            }
            a:link {
                color: #e0e0e0;
            }
            a:hover {
                color: #f0f0ff;
            }
            a:visited {
                color: #f0f0e0;
            }
            div#container {
                width: 100vw;
                margin: 32px auto;
            }
            div.info {
                margin: 32px auto;
                text-align: center;
            }
            div.info > img {
                filter: invert(100%);
            }
            h1 {
                margin: 16px auto;
                text-align: center;
            }
            div#terminal {
                width: 42em;
                margin: 0px auto;
            }
        </style>
    </body>
</html>
```

## Extras

I personally prefer customizing monster and weapon names, so I also applied the following patch. This is optional.

```bash
patch -p1 < ../rogue5.4.5x_ja_rename.patch
```

In some environments, Ctrl+H movement may not work properly. In that case, apply the following patch:

```bash
patch -p1 < ../rogue5.4.5x_ctrl-h.patch
```
