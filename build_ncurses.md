# Ncurses

Rogue は画面の描画時に Ncurses を使用しています。そのため Emscripten がリンク可能な Ncurses ライブラリをあらかじめビルドしておく必要があります。
ビルド時に必要なツールも途中で作成されるため、まず普通にビルドし、カレントディレクトリの build 配下にインストールします。

```bash
curl -OL https://invisible-island.net/archives/ncurses/ncurses-6.5.tar.gz
tar xf ncurses-6.5.tar.gz
cd ncurses-6.5
./configure --prefix=/usr --without-shared  --without-debug --enable-widec
make
make DESTDIR=`pwd`/build install
```

次に Emscripten 用に configure を行い、その後必要なものだけをビルドするように Makefile を修正します。

```bash
emconfigure ./configure --prefix=/usr --without-shared --without-debug --enable-widec
vi Makefile
```

```patch ncurses-6.5/Makefile
--- ncurses-6.5.orig/Makefile	2025-08-01 08:19:13.048115403 +0900
+++ ncurses-6.5/Makefile	2025-08-01 08:21:27.546692707 +0900
@@ -130,15 +130,15 @@
 tags \
 uninstall \
 install ::
-	( cd man && ${MAKE} ${TOP_MFLAGS} $@ )
+	#( cd man && ${MAKE} ${TOP_MFLAGS} $@ )
 	( cd include && ${MAKE} ${TOP_MFLAGS} $@ )
 	( cd ncurses && ${MAKE} ${TOP_MFLAGS} $@ )
-	( cd progs && ${MAKE} ${TOP_MFLAGS} $@ )
+	#( cd progs && ${MAKE} ${TOP_MFLAGS} $@ )
 	( cd panel && ${MAKE} ${TOP_MFLAGS} $@ )
 	( cd menu && ${MAKE} ${TOP_MFLAGS} $@ )
 	( cd form && ${MAKE} ${TOP_MFLAGS} $@ )
-	( cd test && ${MAKE} ${TOP_MFLAGS} $@ )
-	( cd misc && ${MAKE} ${TOP_MFLAGS} $@ )
+	#( cd test && ${MAKE} ${TOP_MFLAGS} $@ )
+	#( cd misc && ${MAKE} ${TOP_MFLAGS} $@ )

 # generated by CF_LIB_RULES

```

```bash
vi ncurses/Makefile
```

```patch ncurses-6.5/ncurses/Makefile
--- ncurses-6.5.orig/ncurses/Makefile	2025-08-01 08:19:13.052115480 +0900
+++ ncurses-6.5/ncurses/Makefile	2025-08-01 08:24:24.382079420 +0900
@@ -253,23 +253,23 @@
 keys.list :	$(tinfo)/MKkeys_list.sh
 	AWK=$(AWK) USE_SIGWINCH=1 $(SHELL) $(tinfo)/MKkeys_list.sh $(CAPLIST) | LC_ALL=C sort >$@

-make_keys$(BUILD_EXEEXT) : \
-		build.priv.h \
-		$(tinfo)/make_keys.c \
-		./names.c
-	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(tinfo)/make_keys.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
-
-make_hash$(BUILD_EXEEXT) : \
-		build.priv.h \
-		$(tinfo)/make_hash.c \
-		../include/hashsize.h
-	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(tinfo)/make_hash.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
-
-report_offsets$(BUILD_EXEEXT) : \
-		$(srcdir)/curses.priv.h \
-		$(srcdir)/report_offsets.c
-	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(srcdir)/report_offsets.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
-	./report_offsets$(BUILD_EXEEXT)
+#make_keys$(BUILD_EXEEXT) : \
+#		build.priv.h \
+#		$(tinfo)/make_keys.c \
+#		./names.c
+#	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(tinfo)/make_keys.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
+
+#make_hash$(BUILD_EXEEXT) : \
+#		build.priv.h \
+#		$(tinfo)/make_hash.c \
+#		../include/hashsize.h
+#	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(tinfo)/make_hash.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
+
+#report_offsets$(BUILD_EXEEXT) : \
+#		$(srcdir)/curses.priv.h \
+#		$(srcdir)/report_offsets.c
+#	$(BUILD_CC) -o $@ $(BUILD_CPPFLAGS) $(BUILD_CCFLAGS) $(srcdir)/report_offsets.c $(BUILD_LDFLAGS) $(BUILD_LIBS)
+#	./report_offsets$(BUILD_EXEEXT)

 ./expanded.c : $(srcdir)/curses.priv.h $(serial)/MKexpanded.sh
 	$(SHELL) -e $(serial)/MKexpanded.sh "$(CPP)" $(CPPFLAGS) > $@
@@ -312,9 +312,9 @@

 clean :: mostlyclean
 	-rm -f $(AUTO_SRC)
-	-rm -f make_keys$(BUILD_EXEEXT)
-	-rm -f make_hash$(BUILD_EXEEXT)
-	-rm -f report_offsets$(BUILD_EXEEXT)
+	#-rm -f make_keys$(BUILD_EXEEXT)
+	#-rm -f make_hash$(BUILD_EXEEXT)
+	#-rm -f report_offsets$(BUILD_EXEEXT)
 	-rm -rf .libs *.dSYM *.map

 distclean :: clean
```

クロスコンパイル & カレントディレクトリの build 配下にインストールします。

```bash
make clean
emmake make
emmake make DESTDIR=`pwd`/build install
```

あとで Rogue のビルド時に必要となるため、Ncurses ライブラリのあるパスの環境変数を設定しておきます。

```bash
export NCURSESDIR=`pwd`/build
```

ビルド後、ncurses-6.5/build/usr/share/terminfo/x　配下に xterm-256color というファイルができていると思いますが、これも xterm.js での表示に必要となるため、適当な場所にコピーしておきます。
